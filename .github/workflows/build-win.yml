name: Build Windows Installer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      # Import and set up the signing certificate
      - name: Import Signing Certificate
        env:
          CERTIFICATE_B64: ${{ secrets.WIN_SIGNING_CERT }}
          CERTIFICATE_PASSWORD: ${{ secrets.WIN_CERT_PASSWORD }}
        run: |
          echo "Decoding certificate..."
          echo "${CERTIFICATE_B64}" | base64 -d > "${{ runner.temp }}/certificate.pfx"
          
          echo "Importing certificate..."
          certutil -f -p "${CERTIFICATE_PASSWORD}" -importpfx "${{ runner.temp }}/certificate.pfx"
          
          echo "Setting up environment variables for signing..."
          echo "CERTIFICATE_PATH=${{ runner.temp }}/certificate.pfx" >> $GITHUB_ENV
          echo "CERTIFICATE_PASSWORD=${CERTIFICATE_PASSWORD}" >> $GITHUB_ENV
          
      - name: Install dependencies
        run: npm install
        working-directory: genaiservices-electron-app

      - name: Build the Electron app
        run: npm run build-win
        working-directory: genaiservices-electron-app

      - name: Sign Executables
        run: |
          echo "Signing executables..."
          for file in $(find genaiservices-electron-app/dist/prod -name "*.exe" -type f); do
            echo "Signing $file"
            signtool sign /f "${CERTIFICATE_PATH}" /p "${CERTIFICATE_PASSWORD}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "$file"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: win-prod-build
          path: genaiservices-electron-app/dist/prod
